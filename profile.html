<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - ExpressDelivery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-firestore-compat.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            font-family: 'Poppins', sans-serif;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .profile-container {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .back-btn {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: translateX(-5px);
        }

        .profile-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            opacity: 0.8;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            outline: none;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: white;
        }

        .save-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            background: white;
            color: #333;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .save-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #23d5ab;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .notification-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        @media (max-width: 768px) {
            .profile-container {
                padding: 10px;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.8;
        }

        .devices-list {
            margin-top: 15px;
        }

        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .device-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .device-icon {
            font-size: 20px;
        }

        .device-name {
            font-size: 14px;
        }

        .device-date {
            font-size: 12px;
            opacity: 0.7;
        }

        .remove-device {
            color: #ff4444;
            cursor: pointer;
            padding: 5px;
        }

        .cards-list {
            margin-top: 20px;
            display: grid;
            gap: 15px;
        }

        .card-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 24px;
        }

        .card-number {
            font-family: monospace;
        }

        .add-payment-btn {
            width: 100%;
            padding: 15px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: transparent;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .add-payment-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .help-text {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }

        .addresses-list {
            margin-bottom: 20px;
        }

        .address-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            position: relative;
        }

        .address-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .address-actions {
            position: absolute;
            right: 15px;
            top: 15px;
            display: flex;
            gap: 10px;
        }

        .add-address-btn {
            width: 100%;
            padding: 15px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: transparent;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            margin: 50px auto;
            color: white;
        }

        .loyalty-info {
            text-align: center;
            padding: 20px;
        }

        .points-display {
            margin-bottom: 30px;
        }

        .points-value {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .loyalty-progress {
            margin-bottom: 30px;
        }

        .progress-bar {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #23d5ab;
            transition: width 0.3s ease;
        }

        .loyalty-benefits {
            text-align: left;
        }

        .login-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .login-entry {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .login-device {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="profile-container">
        <header class="header">
            <a href="dashboard.html" class="back-btn">‚Üê Retour au tableau de bord</a>
            <h1 style="color: white; margin: 0;">Profil</h1>
        </header>

        <div class="profile-section">
            <div class="section-title">üë§ Informations personnelles</div>
            <form id="personalInfoForm" onsubmit="return savePersonalInfo(event)">
                <div class="form-group">
                    <label class="form-label">Nom complet</label>
                    <input type="text" class="form-input" id="fullName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">T√©l√©phone</label>
                    <input type="tel" class="form-input" id="phone" readonly>
                </div>
                <button type="submit" class="save-btn">Enregistrer</button>
                <div class="success-message" id="personalInfoSuccess">
                    Informations mises √† jour avec succ√®s !
                </div>
            </form>
        </div>

        <div class="profile-section">
            <div class="section-title">üìç Adresse par d√©faut</div>
            <form id="addressForm" onsubmit="return saveAddress(event)">
                <div class="form-group">
                    <label class="form-label">Rue</label>
                    <input type="text" class="form-input" id="street" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Code postal</label>
                    <input type="text" class="form-input" id="zipCode" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Ville</label>
                    <input type="text" class="form-input" id="city" required>
                </div>
                <button type="submit" class="save-btn">Enregistrer</button>
                <div class="success-message" id="addressSuccess">
                    Adresse mise √† jour avec succ√®s !
                </div>
            </form>
        </div>

        <div class="profile-section">
            <div class="section-title">üîî Pr√©f√©rences de notification</div>
            <div class="notification-option">
                <span>Notifications push</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="pushNotifications" onchange="toggleNotification('push')">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="notification-option">
                <span>Notifications email</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="emailNotifications" onchange="toggleNotification('email')">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="notification-option">
                <span>Notifications SMS</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="smsNotifications" onchange="toggleNotification('sms')">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="profile-section">
            <div class="section-title">üîê S√©curit√©</div>
            <form id="securityForm" onsubmit="return updateSecurity(event)">
                <div class="form-group">
                    <label class="form-label">Authentification √† deux facteurs</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="twoFactorAuth" onchange="toggle2FA(event)">
                        <span class="slider"></span>
                    </label>
                    <p class="help-text">Recevez un code de confirmation par SMS en plus de votre mot de passe</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Appareils connect√©s</label>
                    <div class="devices-list" id="devicesList">
                        <!-- Rempli dynamiquement -->
                    </div>
                </div>
            </form>
        </div>

        <div class="profile-section">
            <div class="section-title">üí≥ Moyens de paiement</div>
            <div class="payment-methods" id="paymentMethods">
                <button class="add-payment-btn" onclick="addPaymentMethod()">
                    <span class="icon">+</span>
                    Ajouter une carte
                </button>
                <div class="cards-list" id="cardsList">
                    <!-- Rempli dynamiquement -->
                </div>
            </div>
        </div>

        <div class="profile-section">
            <div class="section-title">üìä Statistiques d'envois</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalShipments">0</div>
                    <div class="stat-label">Envois totaux</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="monthlyShipments">0</div>
                    <div class="stat-label">Envois ce mois</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSpent">0‚Ç¨</div>
                    <div class="stat-label">D√©penses totales</div>
                </div>
            </div>
        </div>

        <div class="profile-section">
            <div class="section-title">üéØ Pr√©f√©rences d'envoi</div>
            <form id="preferencesForm" onsubmit="return savePreferences(event)">
                <div class="form-group">
                    <label class="form-label">Mode de livraison pr√©f√©r√©</label>
                    <select class="form-input" id="preferredDelivery">
                        <option value="standard">Standard</option>
                        <option value="express">Express</option>
                        <option value="eco">√âco-responsable</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Instructions par d√©faut</label>
                    <textarea class="form-input" id="defaultInstructions" rows="3" 
                              placeholder="Instructions pour le livreur..."></textarea>
                </div>
                <button type="submit" class="save-btn">Enregistrer</button>
            </form>
        </div>

        <div class="profile-section">
            <div class="section-title">üåç Pr√©f√©rences r√©gionales</div>
            <form id="regionForm" onsubmit="return saveRegionalPreferences(event)">
                <div class="form-group">
                    <label class="form-label">Langue</label>
                    <select class="form-input" id="language">
                        <option value="fr">Fran√ßais</option>
                        <option value="en">English</option>
                        <option value="es">Espa√±ol</option>
                        <option value="de">Deutsch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Devise</label>
                    <select class="form-input" id="currency">
                        <option value="EUR">Euro (‚Ç¨)</option>
                        <option value="USD">Dollar ($)</option>
                        <option value="GBP">Livre Sterling (¬£)</option>
                    </select>
                </div>
                <button type="submit" class="save-btn">Enregistrer</button>
            </form>
        </div>

        <div class="profile-section">
            <div class="section-title">üìç Carnet d'adresses</div>
            <div class="addresses-list" id="addressesList">
                <!-- Rempli dynamiquement -->
            </div>
            <button class="add-address-btn" onclick="showAddAddressModal()">
                <span class="icon">+</span> Ajouter une adresse
            </button>
        </div>

        <div class="profile-section">
            <div class="section-title">üèÜ Programme de fid√©lit√©</div>
            <div class="loyalty-info">
                <div class="points-display">
                    <div class="points-value" id="loyaltyPoints">0</div>
                    <div class="points-label">points fid√©lit√©</div>
                </div>
                <div class="loyalty-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="loyaltyProgress"></div>
                    </div>
                    <div class="progress-label">
                        <span id="pointsToNextLevel">100</span> points jusqu'au prochain niveau
                    </div>
                </div>
                <div class="loyalty-benefits">
                    <h4>Avantages actuels :</h4>
                    <ul id="benefitsList">
                        <!-- Rempli dynamiquement -->
                    </ul>
                </div>
            </div>
        </div>

        <div class="profile-section">
            <div class="section-title">üîê Historique des connexions</div>
            <div class="login-history" id="loginHistory">
                <!-- Rempli dynamiquement -->
            </div>
        </div>
    </div>

    <div class="modal" id="addressModal">
        <div class="modal-content">
            <h3>Ajouter une adresse</h3>
            <form id="addressModalForm" onsubmit="return saveAddress(event)">
                <div class="form-group">
                    <label class="form-label">Nom de l'adresse</label>
                    <input type="text" class="form-input" id="addressName" placeholder="Ex: Domicile, Bureau..." required>
                </div>
                <div class="form-group">
                    <label class="form-label">Rue</label>
                    <input type="text" class="form-input" id="modalStreet" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Compl√©ment d'adresse</label>
                    <input type="text" class="form-input" id="modalAddressComplement">
                </div>
                <div class="form-group">
                    <label class="form-label">Code postal</label>
                    <input type="text" class="form-input" id="modalZipCode" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Ville</label>
                    <input type="text" class="form-input" id="modalCity" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Pays</label>
                    <select class="form-input" id="modalCountry" required>
                        <option value="FR">France</option>
                        <option value="BE">Belgique</option>
                        <option value="CH">Suisse</option>
                        <option value="LU">Luxembourg</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeAddressModal()">Annuler</button>
                    <button type="submit" class="save-btn">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // V√©rifier si l'utilisateur est connect√©
        document.addEventListener('DOMContentLoaded', () => {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                window.location.href = 'login.html';
                return;
            }
            loadUserProfile();
        });

        // Charger le profil utilisateur
        async function loadUserProfile() {
            const userId = localStorage.getItem('userId');
            try {
                const doc = await firebase.firestore()
                    .collection('users')
                    .doc(userId)
                    .get();

                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('fullName').value = data.fullName || '';
                    document.getElementById('email').value = data.email || '';
                    document.getElementById('phone').value = localStorage.getItem('userPhone') || '';
                    document.getElementById('street').value = data.address?.street || '';
                    document.getElementById('zipCode').value = data.address?.zipCode || '';
                    document.getElementById('city').value = data.address?.city || '';
                    
                    // Charger les pr√©f√©rences de notification
                    document.getElementById('pushNotifications').checked = data.notifications?.push || false;
                    document.getElementById('emailNotifications').checked = data.notifications?.email || false;
                    document.getElementById('smsNotifications').checked = data.notifications?.sms || false;
                }
            } catch (error) {
                console.error('Erreur lors du chargement du profil:', error);
            }
        }

        // Sauvegarder les informations personnelles
        async function savePersonalInfo(event) {
            event.preventDefault();
            const userId = localStorage.getItem('userId');
            const successMessage = document.getElementById('personalInfoSuccess');

            try {
                await firebase.firestore()
                    .collection('users')
                    .doc(userId)
                    .update({
                        fullName: document.getElementById('fullName').value,
                        email: document.getElementById('email').value,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                successMessage.style.display = 'block';
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
            }
            return false;
        }

        // Sauvegarder l'adresse
        async function saveAddress(event) {
            event.preventDefault();
            const userId = localStorage.getItem('userId');
            const successMessage = document.getElementById('addressSuccess');

            try {
                await firebase.firestore()
                    .collection('users')
                    .doc(userId)
                    .update({
                        address: {
                            street: document.getElementById('street').value,
                            zipCode: document.getElementById('zipCode').value,
                            city: document.getElementById('city').value
                        },
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                successMessage.style.display = 'block';
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
            }
            return false;
        }

        // G√©rer les pr√©f√©rences de notification
        async function toggleNotification(type) {
            const userId = localStorage.getItem('userId');
            const checkbox = document.getElementById(`${type}Notifications`);

            try {
                const update = {};
                update[`notifications.${type}`] = checkbox.checked;

                await firebase.firestore()
                    .collection('users')
                    .doc(userId)
                    .update(update);

                if (type === 'push' && checkbox.checked) {
                    // Demander la permission pour les notifications push
                    requestPushPermission();
                }
            } catch (error) {
                console.error('Erreur lors de la mise √† jour des notifications:', error);
                checkbox.checked = !checkbox.checked; // R√©tablir l'√©tat pr√©c√©dent
            }
        }

        // Demander la permission pour les notifications push
        async function requestPushPermission() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const messaging = firebase.messaging();
                    const token = await messaging.getToken();
                    await saveMessagingToken(token);
                }
            } catch (error) {
                console.error('Erreur lors de la demande de permission:', error);
            }
        }

        // Sauvegarder le token de messagerie
        async function saveMessagingToken(token) {
            const userId = localStorage.getItem('userId');
            try {
                await firebase.firestore()
                    .collection('users')
                    .doc(userId)
                    .update({
                        messagingTokens: firebase.firestore.FieldValue.arrayUnion(token)
                    });
            } catch (error) {
                console.error('Erreur lors de la sauvegarde du token:', error);
            }
        }

        // Charger les statistiques
        async function loadStats() {
            const userId = localStorage.getItem('userId');
            try {
                const stats = await firebase.firestore()
                    .collection('users')
                    .doc(userId)
                    .collection('stats')
                    .doc('shipping')
                    .get();

                if (stats.exists) {
                    const data = stats.data();
                    document.getElementById('totalShipments').textContent = data.total || 0;
                    document.getElementById('monthlyShipments').textContent = data.monthly || 0;
                    document.getElementById('totalSpent').textContent = `${data.totalSpent || 0}‚Ç¨`;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
            }
        }

        // G√©rer les appareils connect√©s
        async function loadDevices() {
            const userId = localStorage.getItem('userId');
            const devicesList = document.getElementById('devicesList');
            
            try {
                const devices = await firebase.firestore()
                    .collection('users')
                    .doc(userId)
                    .collection('devices')
                    .get();

                devicesList.innerHTML = '';
                devices.forEach(doc => {
                    const device = doc.data();
                    devicesList.innerHTML += `
                        <div class="device-item">
                            <div class="device-info">
                                <span class="device-icon">${getDeviceIcon(device.type)}</span>
                                <div>
                                    <div class="device-name">${device.name}</div>
                                    <div class="device-date">Derni√®re connexion: ${formatDate(device.lastLogin)}</div>
                                </div>
                            </div>
                            <span class="remove-device" onclick="removeDevice('${doc.id}')">√ó</span>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Erreur lors du chargement des appareils:', error);
            }
        }

        // G√©rer les cartes de paiement
        async function loadPaymentMethods() {
            const userId = localStorage.getItem('userId');
            const cardsList = document.getElementById('cardsList');
            
            try {
                const cards = await firebase.firestore()
                    .collection('users')
                    .doc(userId)
                    .collection('payment_methods')
                    .get();

                cardsList.innerHTML = '';
                cards.forEach(doc => {
                    const card = doc.data();
                    cardsList.innerHTML += `
                        <div class="card-item">
                            <div class="card-info">
                                <span class="card-icon">üí≥</span>
                                <div>
                                    <div class="card-number">**** **** **** ${card.last4}</div>
                                    <div class="card-date">Expire: ${card.expMonth}/${card.expYear}</div>
                                </div>
                            </div>
                            <span class="remove-device" onclick="removeCard('${doc.id}')">√ó</span>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Erreur lors du chargement des moyens de paiement:', error);
            }
        }

        // Sauvegarder les pr√©f√©rences
        async function savePreferences(event) {
            event.preventDefault();
            const userId = localStorage.getItem('userId');
            
            try {
                await firebase.firestore()
                    .collection('users')
                    .doc(userId)
                    .update({
                        preferences: {
                            deliveryMode: document.getElementById('preferredDelivery').value,
                            defaultInstructions: document.getElementById('defaultInstructions').value
                        }
                    });

                showSuccess('Pr√©f√©rences enregistr√©es avec succ√®s');
            } catch (error) {
                console.error('Erreur lors de la sauvegarde des pr√©f√©rences:', error);
            }
            return false;
        }

        // Fonctions utilitaires
        function getDeviceIcon(type) {
            const icons = {
                mobile: 'üì±',
                tablet: 'üì±',
                desktop: 'üíª',
                other: 'üîå'
            };
            return icons[type] || icons.other;
        }

        function formatDate(timestamp) {
            if (timestamp instanceof firebase.firestore.Timestamp) {
                timestamp = timestamp.toDate();
            }
            return new Date(timestamp).toLocaleDateString('fr-FR', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadDevices();
            loadPaymentMethods();
        });

        // Charger les adresses
        async function loadAddresses() {
            const userId = localStorage.getItem('userId');
            try {
                const snapshot = await firebase.firestore()
                    .collection('users')
                    .doc(userId)
                    .collection('addresses')
                    .get();

                const addressesList = document.getElementById('addressesList');
                addressesList.innerHTML = '';

                snapshot.forEach(doc => {
                    const address = doc.data();
                    addressesList.innerHTML += `
                        <div class="address-card">
                            <div class="address-name">${address.name}</div>
                            <div>${address.street}</div>
                            ${address.complement ? `<div>${address.complement}</div>` : ''}
                            <div>${address.zipCode} ${address.city}</div>
                            <div>${getCountryName(address.country)}</div>
                            <div class="address-actions">
                                <button onclick="editAddress('${doc.id}')" class="icon-btn">‚úèÔ∏è</button>
                                <button onclick="deleteAddress('${doc.id}')" class="icon-btn">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Erreur lors du chargement des adresses:', error);
            }
        }

        // Charger les points de fid√©lit√©
        async function loadLoyaltyInfo() {
            const userId = localStorage.getItem('userId');
            try {
                const doc = await firebase.firestore()
                    .collection('users')
                    .doc(userId)
                    .get();

                const loyalty = doc.data().loyalty || { points: 0, level: 1 };
                document.getElementById('loyaltyPoints').textContent = loyalty.points;
                
                const pointsToNext = calculatePointsToNextLevel(loyalty.points);
                document.getElementById('pointsToNextLevel').textContent = pointsToNext;
                
                const progress = (loyalty.points % 100) + '%';
                document.getElementById('loyaltyProgress').style.width = progress;

                updateLoyaltyBenefits(loyalty.level);
            } catch (error) {
                console.error('Erreur lors du chargement des points fid√©lit√©:', error);
            }
        }

        // Charger l'historique des connexions
        async function loadLoginHistory() {
            const userId = localStorage.getItem('userId');
            try {
                const snapshot = await firebase.firestore()
                    .collection('users')
                    .doc(userId)
                    .collection('loginHistory')
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();

                const historyContainer = document.getElementById('loginHistory');
                historyContainer.innerHTML = '';

                snapshot.forEach(doc => {
                    const login = doc.data();
                    historyContainer.innerHTML += `
                        <div class="login-entry">
                            <div class="login-device">
                                <span class="device-icon">${getDeviceIcon(login.deviceType)}</span>
                                <div>
                                    <div>${login.deviceName}</div>
                                    <div class="login-location">${login.location}</div>
                                </div>
                            </div>
                            <div class="login-time">${formatDate(login.timestamp)}</div>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Erreur lors du chargement de l\'historique:', error);
            }
        }

        // Fonctions utilitaires
        function calculatePointsToNextLevel(points) {
            return 100 - (points % 100);
        }

        function updateLoyaltyBenefits(level) {
            const benefits = {
                1: ['5% de r√©duction sur les envois'],
                2: ['10% de r√©duction sur les envois', 'Acc√®s prioritaire au support'],
                3: ['15% de r√©duction sur les envois', 'Support VIP', 'Livraison express gratuite']
            };

            const benefitsList = document.getElementById('benefitsList');
            benefitsList.innerHTML = benefits[level].map(benefit => 
                `<li>${benefit}</li>`
            ).join('');
        }

        function getCountryName(code) {
            const countries = {
                'FR': 'France',
                'BE': 'Belgique',
                'CH': 'Suisse',
                'LU': 'Luxembourg'
            };
            return countries[code] || code;
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            loadAddresses();
            loadLoyaltyInfo();
            loadLoginHistory();
        });
    </script>
</body>
</html> 